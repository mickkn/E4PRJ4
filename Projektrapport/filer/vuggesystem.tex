% Vuggesystem
\chapter{Vuggesystem}\label{vuggesys}
Vuggesystemet består af en PSoC4 microcontroller som reguleringsmodul til et mekanisk system der vugger barnevognskurven monteret på Baby Watch barnevognen. \\ PSoC4 microcontrolleren bruger en sensorkreds med indbygget accelerometer og gyroskop placeret på akslen barnevognskurven vugges over til at måle vinklen i forhold til tyngdefeltet. \\ I hver af ende af barnevognen er placeret en enstopsensor. Disse registrerer når det mekaniske vuggesystems ydre vuggegrænse er nået og ved aktivering nødstoppes vuggesystemet. \\ Vuggesystemet kommunikerer også med Controller. Dette sker ved hjælp af et I2C-interface. Kommunikationen består af parametre send til vuggesystemet om hvilken frekvens og hvilken vinkel-amplitude barnevognskurven skal vugges med samt en indikation på eventuelle fejl i vuggesystemet som Controller kan aflæse.

Til at trække det mekaniske vuggesystem er en motor monteret med en tilhørende motorkreds. Denne motorkreds styres af et PWM-signal genereret ud fra beregninger lavet på baggrund af sensor input og parametrene sendt fra Controller.

De efterfølgende afsnit beskriver kort vuggesystemets Systemarkitektur efterfulgt af Hardware Design og Implementeringen og tilsidst Software Design og Implementeringen.

\section{Systemarkitektur}
\label{vs_sysark}
Systemarkitekturen for vuggesystemet er udarbejdet ud fra use casene fra kravspecifikationen i Baby Watch projektdokumentationen \textit{Kapitel 3 Kravspecifikation} -> \textit{3.2 Use cases}. Ud fra den ønskede funktionalitet er følgende hardware opbygning valgt:

\figur{1}{vuggesystem/Vuggesystem_IBD}{IBD diagram for Vuggesystem}{vuggesystem:ibd}

Den centrale enhed her er Regulerings MCU'en. Herunder ses et sekvensdiagram for dennes adfærd baseret på de opstillede krav til denne del af systemet:

\figur{1}{vuggesystem/reguleringsMCU_SD}{SD, for Vuggesystems styre enhed, fra applikationsmodellen}{vuggesystem:SD}

Modulet regulering står for interfacet til :Motorsystem blokken fra figur \ref{vuggesystem:ibd}, mens modulet sensorfortolker står for forbindelsen til blokken :Sensor.\\

Det ses på figur \ref{vuggesystem:SD} hvordan regulerings MCU'en efter en indledende opsætning kører i en løkke som konstant undersøger vuggesystemets tilstand baseret på sensor data, beregner en korrektion, og sender denne til motor kredsen. \\

Denne arkitektur er benyttet som grundlag for senere designvalg. En fuld beskrivelse af arkitekturen og dens tilblivelse findes i projektdokumentationens afsnit: \textit{Vuggesystem -> Systemarkitektur}.\\

\section{Design}
\label{vs_design}

\figur{1}{vuggesystem/reguleringsMCU_klassediagram.pdf}{Klassediagram for Vuggesystem}{vuggesystem:klassediagram}




\section{HW Design og Implementering}
\label{vs_HW}
Da vuggesystemet er opbygget omkring en PSoC 4 chip er det kun effektdrivende hardware der har været nødvændigt at implementere eksternt, hvorfor det kun er Motorstyringskredsen der er implementeret som et selvstændigt kredsløb, mens systemets sensorer kan kobles direkte til PSoC'en. De to endstop switches er samlet i et signal for at spare en pin. Herunder ses et diagram over det implementerede hardware:\\
\figur{1}{vuggesystem/HW_schematic.pdf}{Samlet kredsløbsdiagram for Vuggesystem}{vuggesystem:hwdesign}
Det ses her at en H-bro med power mosfet's styret af dobbelt siddede MOS drivere benyttes til at styre motoren. Dette kræver et PWM signal som inverteres, med et dødbånd for at sikre mod at der sendes strøm forbi motoren ved skift, hvilket igen er valgt implementeret på PSoC'en i stedet for i ekstern HW. \\ Systemet indeholder desuden to optokoblere som benyttes til at skabe galvanisk adskillelse af motorkredsen som har tendens til støj.
For en dybdegående gennemgang af design og implementering af ovenstående kreds henvises til projektdokumentationens afsnit \textit{7.2.1 Hardware Design} og \textit{7.3.1 Hardware Implementering}.\\



\subsection*{Software}
\label{vs_implementering_sw}


\subsection*{Hardware}
\label{vs_implementering_hw}

