\newpage
\section{Systemarkitektur}

I dette afsnit beskrives systemarkitekturen for den intelligente lydmonitor.

\subsection*{Overordnet virkemåde}
Overordnet skal den intelligente lydmonitor fungere som følger:
\begin{itemize}
	\item Babyens gråd detekteres med en mikrofon og forstærkes med en mikrofonforstærker inden det analoge signal konverteres til diskrete samples med Blackfin's ADC
	\item Den diskrete sample-sekvens forfiltreres. Sample-sekvensen lavpasfiltreres og nedsamples for herefter at blive højpasfiltreret. Det forfiltrerede sample gemmes i bufferen, der skal holde 5 sekunders optagelse.
	\item Den filtrerede sample-sekvens i bufferen analyseres først for Sound Pressure Level (SPL) for at bedømme hvorvidt der er lyd nok til at den efterfølgende FFT kan betale sig. 
	\item Et evt. resultat af FFT'en kategoriseres som én af tre BABYCON-states, som beskrevet i \ref{kravspec:indledning_babycon_states} 
	\item Den fundne BABYCON state holdes op mod en statistik over tidligere states for at sikre mod evt. fejl-state.
	\item Det endelige kategoriseringsresult sendes til Controller via TwoWireCom
\end{itemize}

\figur{1}{intlydmonitor/sysark/Intelligent_Lydmonitor_Systemtegning.pdf}{Overordnet virkemåde for Intelligent Lydmonitor}{IL_virmåde}

\newpage
\subsection{Hardware arkitektur}
I dette afsnit beskrives hardware arkitekturen for Intelligent Lydmonitor. Den er skitseret IBD'et herunder:
\figur{1}{intlydmonitor/sysark/Intelligent_Lydmonitor_IBD.pdf}{IBD for Intelligent Lydmonitor}{IL_IBD}

Som det ses af Figur \ref{IL_IBD} består \textbf{Intelligent Lydmonitor} af tre dele: 
\begin{itemize}
\item \textbf{Mikrofon} optager signalet babyLyd, som er lyden Baby producerer. 
\item \textbf{Mic Preamp} modtager og forstærker signalet opLyd fra Mikrofon, hvilket er den lyd Mikrofon har optaget. 
\item \textbf{Blackfin} modtager forstærket lyd, forLyd, fra Mic Preamp. Blackfin analyserer lyden og kategoriserer denne, inden den via to signalledere sender kategoriseringen til Controller. 
\end{itemize}

\newpage
\subsection{Software arkitektur}
I dette afsnit beskrives software-arkitekturen for Intelligent Lydmonitor. Det vil tage udgangspunkt i \ref{IL_virmåde} og består af et sekvensdiagram, et klassediagram og en efterfølgende funktionsbeskrivelser.

\subsubsection*{Sekvensdiagram}
Herunder ses sekvensdiagrammet for en komplet lyd-analyse i Intelligent Lydmonitor.
\figur{1}{intlydmonitor/sysark/Intelligent_Lydmonitor_SD.pdf}{SD for Intelligent Lydmonitor}{IL_SD}

\ref{IL_SD} viser interaktionen mellem Intelligent Lydmonitors subklasser.

Klassen \textbf{PreFilter} står for forfiltreringen af sample-sekvensen. PreFilter har tre funktioner, \textit{lowpass()} som lavpasfiltrerer sample-sekvensen, \textit{downsample()} som nedsampler sekvensen og \textit{highpass()} som højpasfiltrerer den nedsamplede sekvens af hensyn til lavfrekvent støj fra vind og vejr. PreFilter kalder efter sit gennemløb RecBuf's funktion \textit{set()} for at gemme samplen.
\textbf{RecBuf} er cirkulær buffer med mulighed for midlertidig locking af bufferområder. Det er altså en buffer der muliggør påfyldning af data ét sted mens aflæsning foregår fra et låst segment. Se \ref{intlyd:sw:circ_buf} for yderligere beskrivelse. Når RecBuf har indsamlet nye samples svarende til 5 sekunders optagelse kaldes \textit{analyze()}. \textbf{Analyzer} analyserer nu data i RecBuf via funktionerne \textit{calcSPL()} og dernæst \textit{calcFFT}, hvis SPL er over threshold. Resultatet sendes til \textbf{Categorizer} via funktionen \textit{categorize}, der kategoriserer resultatet indenfor de tre BABYCON niveauer (1,2 og 3). Funktionen \textit{calcSignificans} i \textbf{Statistician} kaldes hernæst og det nyligt fundne BABYCON-niveau sammenlignes med tidligere niveauer for at finde sænke risiko for en evt. fejlmelding. Til slut sendes det fundne BABYCON-niveau til Controller via \textbf{TwoWireCom}. 

\subsubsection*{Klassediagram}
I UML-klassediagrammet herunder ses en oversigt over system-klassernes attributter og funktioner samt deres indbyrdes relationer. 
\figur{1}{intlydmonitor/sysark/Intelligent_Lydmonitor_UML.pdf}{UML for Intelligent Lydmonitor}{IL_UML}
Funktionsbeskrivelser findes i det efterfølgende afsnit. 

\subsubsection*{Funktionsbeskrivelse}

\textit{PreFilter} \\
\textbf{Ansvar:} Klassen indeholder funktionaliteten til forfiltrering og nedsampling af den diskrete sampling-sekvens.


\begin{center}
    \begin{tabular}{ | l | p{11,8cm} |}
    \hline
    \textbf{Funktion}	& \verb+void init(int lpFreq, int hpFreq, int factor, int *curSample) +						\\ \hline
    \textbf{Parametre} 	& int lpFreq knækfrekvens for LP-filter,\\&
    						  int hpFreq knækfrekvens for HP-filter,\\&
    						  int factor nedsamplingsfaktor, \\&
    						  int *curSample pointer til placering af nyeste sample		\\ \hline
    \textbf{Returværdi}	& Ingen																				\\ \hline
    \textbf{Beskrivelse}	& Initialiserer filtre og downsampling, ved at kalde deres init-funktioner		\\ \hline
    \end{tabular}
\end{center}

\begin{center}
    \begin{tabular}{ | l | p{11,8cm} |}
    \hline
    \textbf{Funktion}	& \verb+void initLP(int freqLP) +						\\ \hline
    \textbf{Parametre} 	& int lpFreq knækfrekvens for LP-filter		\\ \hline
    \textbf{Returværdi}	& Ingen 								\\ \hline
    \textbf{Beskrivelse}	& Initialiserer LP-filter		\\ \hline
    \end{tabular}
\end{center}

\begin{center}
    \begin{tabular}{ | l | p{11,8cm} |}
    \hline
    \textbf{Funktion}	& \verb+void initHP(int freqHP) +						\\ \hline
    \textbf{Parametre} 	& int hpFreq knækfrekvens for HP-filter		\\ \hline
    \textbf{Returværdi}	& Ingen 								\\ \hline
    \textbf{Beskrivelse}	& Initialiserer HP-filter		\\ \hline
    \end{tabular}
\end{center}

\begin{center}
    \begin{tabular}{ | l | p{11,8cm} |}
    \hline
    \textbf{Funktion}	& \verb+void initDown(int factor) +						\\ \hline
    \textbf{Parametre} 	& int factor faktor for nedsampling		\\ \hline
    \textbf{Returværdi}	& Ingen 								\\ \hline
    \textbf{Beskrivelse}	& Initialiserer downsampling		\\ \hline
    \end{tabular}
\end{center}

\begin{center}
    \begin{tabular}{ | l | p{11,8cm} |}
    \hline
    \textbf{Funktion}	& \verb+void sampleRdy(void) +						\\ \hline
    \textbf{Parametre} 	& Ingen		\\ \hline
    \textbf{Returværdi}	& Ingen 								\\ \hline
    \textbf{Beskrivelse}	& Kaldes ved erhvervelse af nyt sample. Kalder funktionerne lowpass(), highpass() og downsample()		\\ \hline
    \end{tabular}
\end{center}

\begin{center}
    \begin{tabular}{ | l | p{11,8cm} |}
    \hline
    \textbf{Funktion}	& \verb+int highpass(int sample) +						\\ \hline
    \textbf{Parametre} 	& Int sample, sample til HP-filtrering		\\ \hline
    \textbf{Returværdi}	& int, værdi efter filtrering 								\\ \hline
    \textbf{Beskrivelse}& Højpasfiltrerer sample		\\ \hline
    \end{tabular}
\end{center}

\begin{center}
    \begin{tabular}{ | l | p{11,8cm} |}
    \hline
    \textbf{Funktion}	& \verb+int lowpass(int sample) +						\\ \hline
    \textbf{Parametre} 	& Int sample, sample til LP-filtrering		\\ \hline
    \textbf{Returværdi}	& int, værdi efter filtrering 								\\ \hline
    \textbf{Beskrivelse}& Lavpasfiltrerer sample		\\ \hline
    \end{tabular}
\end{center}


\begin{center}
    \begin{tabular}{ | l | p{11,8cm} |}
    \hline
    \textbf{Funktion}	& \verb+bool downsample(void) +						\\ \hline
    \textbf{Parametre} 	& Ingen		\\ \hline
    \textbf{Returværdi}	&  bool, 1 hvis det givne sample skal beholdes og 0 hvis det skal frasorteres 								\\ \hline
    \textbf{Beskrivelse}& Frasorterer samples jf. valgt nedsampling		\\ \hline
    \end{tabular}
\end{center}


\textit{RecBuf} \\
\textbf{Ansvar:} For at kunne opsamle data, mens der bliver behandlet andet data, er det valgt at benytte multiple buffering. Der fyldes i en buffer til denne er fuld, dette data sættes til behandling mens den næste buffer fyldes osv.

\begin{center}
    \begin{tabular}{ | l | p{11,8cm} |}
    \hline
    \textbf{Funktion}	& \verb+RecBuf(int size) +						\\ \hline
    \textbf{Parametre} 	& int size, størrelsen a buffer		\\ \hline
    \textbf{Returværdi}	& Ingen 								\\ \hline
    \textbf{Beskrivelse}& Constructor allokerer og initialiserer buffer, mem0 og mem1 med størrelsen size		\\ \hline
    \end{tabular}
\end{center} 

\begin{center}
    \begin{tabular}{ | l | p{11,8cm} |}
    \hline
    \textbf{Funktion}	& \verb+void storeData(fract16 sample ) +						\\ \hline
    \textbf{Parametre} 	& fract16 sample: Diskret værdi som repræsenterer det momentane spændingsniveau på Blackfin 533 ADC indgang efter filtrering	\\ \hline
    \textbf{Returværdi}	& Ingen 								\\ \hline
    \textbf{Beskrivelse}& Gemmer diskret sample i RecBuf med pladsen index\_		\\ \hline
    \end{tabular}
\end{center} 



\textit{Analyzer} \\
\textbf{Ansvar:} Klassen Analyzer indeholder analyse-funktionerne.

\begin{center}
    \begin{tabular}{ | l | p{11,8cm} |}
    \hline
    \textbf{Funktion}	& \verb+void analyze(uint startindex, uint size) +			\\ \hline
    \textbf{Parametre} 	& uint startindex, startindex for datatilgang i RecBuf		\\ 
    					& uint size, størrelse på datasekvens						\\ \hline
    \textbf{Returværdi}	& Ingen 													\\ \hline
    \textbf{Beskrivelse}& Sætter startIndex og recSize og kalder funktionerne calcSPL() og hvis SPL er over splThresh kaldes calcFFT(). Slutteligt kaldes categorize() med analyseresultatet	\\ \hline
    \end{tabular}
\end{center} 

\begin{center}
    \begin{tabular}{ | l | p{11,8cm} |}
    \hline
    \textbf{Funktion}	& \verb+int calcSPL(void) +						\\ \hline
    \textbf{Parametre} 	& Ingen		\\ \hline
    \textbf{Returværdi}	& int, værdi af SPL 								\\ \hline
    \textbf{Beskrivelse}& Beregner Sound Pressure Level af samplesekvensen fra RecBuf. Denne tilgås via RecBuf's get()		\\ \hline
    \end{tabular}
\end{center} 

\begin{center}
    \begin{tabular}{ | l | p{11,8cm} |}
    \hline
    \textbf{Funktion}	& \verb+void calcFFT(void) +						\\ \hline
    \textbf{Parametre} 	& Ingen		\\ \hline
    \textbf{Returværdi}	& Ingen							\\ \hline
    \textbf{Beskrivelse}& Beregner frekvensspektret via en fast fourier transformation af samplesekvensen fra RecBuf. Denne tilgås via RecBuf's get(). Herefter kaldes gain2dB() og smooth() for at klargøre data til efterfølgende kategorisering. Frekvensspektret gemmes i freqSpec\\ \hline
    \end{tabular}
\end{center}

\begin{center}
    \begin{tabular}{ | l | p{11,8cm} |}
    \hline
    \textbf{Funktion}	& \verb+void gain2dB(void) +						\\ \hline
    \textbf{Parametre} 	& Ingen		\\ \hline
    \textbf{Returværdi}	& Ingen							\\ \hline
    \textbf{Beskrivelse}& Konverterer frekvensspektret freqSpec fra gg til dB \\ \hline
    \end{tabular}
\end{center}  

\begin{center}
    \begin{tabular}{ | l | p{11,8cm} |}
    \hline
    \textbf{Funktion}	& \verb+void smooth(void) +						\\ \hline
    \textbf{Parametre} 	& Ingen		\\ \hline
    \textbf{Returværdi}	& Ingen							\\ \hline
    \textbf{Beskrivelse}& Udglatter frekvensspektret vha. et rekursivt midlingsfilter  \\ \hline
    \end{tabular}
\end{center}

\begin{center}
    \begin{tabular}{ | l | p{11,8cm} |}
    \hline
    \textbf{Funktion}	& \verb+void calcTPR(void) +						\\ \hline
    \textbf{Parametre} 	& Ingen		\\ \hline
    \textbf{Returværdi}	& Ingen							\\ \hline
    \textbf{Beskrivelse}& Beregner TPR (Tonal power ratio) for frekvensspektret freqSpec  \\ \hline
    \end{tabular}
\end{center} 


\textit{Categorizer} \\
\textbf{Ansvar:} Klassen Categorizer står for BABYCON kategorisering af resultaterne fra Analyzer

\begin{center}
    \begin{tabular}{ | l | p{11,8cm} |}
    \hline
    \textbf{Funktion}	& \verb+Categorizer(Statistician* statPtr,+ \\
    					& \verb+uint broadFreqLow, uint broadFreqHigh,+\\
    					& \verb+uint dBroadThreshHighBC1,+\\
    					& \verb+uint dBroadThreshLowBC2, uint dBroadThreshHighBC2,+ \\
    					& \verb+uint firstPeakFreqBC1, uint secondPeakFreqBC1,+ \\
    					& \verb+uint freqMargin) +						\\ \hline
    \textbf{Parametre} 	& Statistician* statPtr, pointer til klassen Statistician \\
    					& uint broadFreqLow, lavest tilladelige værdi for frekvenshældning for BABYCON2 \\
    					& uint broadFreqHigh, højest tilladelige værdi for frekvenshældning for BABYCON2 \\
    					& uint dBroadThreshHighBC1, høje threshhold for frekvenshældning ved BABYCON1 \\
    					& uint dBroadThreshLowBC2, lave threshhold for frekvenshældning ved BABYCON2  \\
    					& uint dBroadThreshHighBC2, høje threshhold for frekvenshældning ved BABYCON2 \\
    					& uint firstPeakFreqBC1, analysefrekvensen for frekvensspektrets første peak       \\	
    					& uint secondPeakFreqBC1, analysefrekvensen for frekvensspektrets anden peak \\
    					& uint freqMargin, margin til bestemmelse af frekvenspeaks \\ \hline
    \textbf{Returværdi}	& Ingen	 								\\ \hline
    \textbf{Beskrivelse}& Constructor sætter relevante kategoriseringsparametre		\\ \hline
    \end{tabular}
\end{center}

\begin{center}
    \begin{tabular}{ | l | p{11,8cm} |}
    \hline
    \textbf{Funktion}	& \verb+void categorize(int* freqSpecPtr, uint freqSpecSize, int tpr) +						\\ \hline
    \textbf{Parametre} 	& int* freqSpecPtr, pointer til frekvensspektrum \\
    					& uint freqSpecSize, størrelse af freqSpec \\
    					& int tpr, tonal power ratio	\\ \hline
    \textbf{Returværdi}	& Ingen	 								\\ \hline
    \textbf{Beskrivelse}& Kategoriserer BABYCON-niveau på baggrund af frekvensspektrum og TPR. Kalder Statisticians calcSignificans() med BABYCON-niveau		\\ \hline
    \end{tabular}
\end{center}

\begin{center}
    \begin{tabular}{ | l | p{11,8cm} |}
    \hline
    \textbf{Funktion}	& \verb+void categorize(void) +						\\ \hline
    \textbf{Parametre} 	& Ingen 								\\ \hline
    \textbf{Returværdi}	& Ingen	 								\\ \hline
    \textbf{Beskrivelse}& Hvis categorize kaldes uden parametre kaldes calcSignificans() med BABYCON3		\\ \hline
    \end{tabular}
\end{center}

\begin{center}
    \begin{tabular}{ | l | p{11,8cm} |}
    \hline
    \textbf{Funktion}	& \verb+bool checkBC1(void) +						\\ \hline
    \textbf{Parametre} 	& Ingen 								\\ \hline
    \textbf{Returværdi}	& bool, true hvis BABYCON1 	 								\\ \hline
    \textbf{Beskrivelse}& Returnerer true hvis BABYCON1		\\ \hline
    \end{tabular}
\end{center}

\begin{center}
    \begin{tabular}{ | l | p{11,8cm} |}
    \hline
    \textbf{Funktion}	& \verb+bool checkBC2(void) +						\\ \hline
    \textbf{Parametre} 	& Ingen 								\\ \hline
    \textbf{Returværdi}	& bool, true hvis BABYCON2 	 								\\ \hline
    \textbf{Beskrivelse}& Returnerer true hvis BABYCON2		\\ \hline
    \end{tabular}
\end{center}



\textit{Statistician} \\
\textbf{Ansvar:} Klassen Statistician står for at beregne mest signifikante BABYCON status. Giver besked til TwoWireCom. 

\begin{center}
    \begin{tabular}{ | l | p{11,8cm} |}
    \hline
    \textbf{Funktion}	& \verb+void calcSignificans(uint bc) +						\\ \hline
    \textbf{Parametre} 	& uint bc, BABYCON-niveau		\\ \hline
    \textbf{Returværdi}	& Ingen	 								\\ \hline
    \textbf{Beskrivelse}& Indsætter den modtagne BABYCON i FIFO-kø og beregner mest signifikante BABYCON status, sender aktiv besked til TwoWireCom		\\ \hline
    \end{tabular}
\end{center}


\textit{TwoWireCom} \\
\textbf{Ansvar:} Klassen TwoWireCom står for at sende BABYCON-niveau til Controller jf. \ref{overordnet:graenseflade_IL}

\begin{center}
    \begin{tabular}{ | l | p{11,8cm} |}
    \hline
    \textbf{Funktion}	& \verb+void send(int bc) +						\\ \hline
    \textbf{Parametre} 	& int bc: Nuværende BABYCON-niveau			\\ \hline
    \textbf{Returværdi}	& Ingen	 								\\ \hline
    \textbf{Beskrivelse}& Sender BABYCON-niveau til Controller		\\ \hline
    \end{tabular}
\end{center}


