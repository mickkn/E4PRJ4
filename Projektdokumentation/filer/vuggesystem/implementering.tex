\section{Implementering}
\label{Vuggesystem: Implementering} 
\subsection{Hardware implementering}

\subsubsection{Motorstyringskreds og endstop kreds}
Motorstyringskredsløbet er det kredsløb i hele systemet som trækker mest effekt, og har derfor været underlagt en række særlige betragtninger for at sikre at kredsløbet ikke forstyrer resten af systemet. Den fysiskke kreds er implementeret på et print sammen med endstop kredsløbet. Layoutet er som følger:

\figur{0.5}{vuggesystem/impl/motorkreds_layout.pdf}{Print layoutet for motorstyringskredsen og endstop kontakterne}{vugsys:motorkreds_layout}

De to kredsløb er placeret på samme print udelukkende for at spare plads. Dette er vurderet problemfrit udfra den batragting at endstop kredsen er stort set ufølsom overefor støj.\\

En mere detaljeret beskrivelse af designbetragningerne for endstop kredsløbet kan findes i EMC rapporten. De to mest centrale ting er afkoblingskondensatorerne (makeret med gult i figur \ref{vugsys:motorkreds_layout}) og brugen af groundplan (makeret med stiplet rødt omrids). \\

Kredsløbets eksterne forbindelser er lavet med Harwin pins til signalforbindelser (sv1 og sv2 i diagrammet), og skrueterminaler til effektforbindelserne (X1 og X2)

\newpage
\subsubsection{Endstopsensor}\label{Vuggesystem: Implementering_ES} 
Endstop sensorene er blevet realiseret ved hjælp af to end stop switches. En endstop switch fungere som en alm. switch der ved aktivering skaber forbindelse mellem to punkter. Figuren under viser en tilsvarende udgave af en end stop switch som dem brugt i projektet.
\figur{0.2}{vuggesystem/impl/ES_SWITCH.pdf}{Generisk end stop switch}{VS_Im_ES_SWITCH}
 Disse end stop switches er placeret således at når barnevognskurven på Baby Watch systemet går ud i en yder vippeposition så aktivers en end stop switch.
\figur{0.5}{vuggesystem/impl/Endstop_Sensor.pdf}{Monteret endstop sensor}{VS_Im_ES_Sensor}
Endstop sensorne er herefter forbundet til endstop kredsløbet som anvist i Vuggesystem Design afsnit \vref{Vuggesystem: Design_ES}. \\
Implementeringen af endstop sensor kredsløbet kan ses i det foregående Motorstyringskreds afsnit på figur \vref{vugsys:motorkreds_layout}
\newpage
\subsubsection{Vuggeudsving sensor}
\label{Vuggesystem: Implementering_VuggeudsvingSensor}
Vuggeudsvingssensoren er implementeret som beskrevet i Vuggesystem Design afsnittet \vref{Vuggesystem: Design_Vugggeudsving_sensor} ved hjælp af en MPU6050 chip med indbygget accelerometer, gyroskop og I2C bus interface. Den er placeret på undersiden af barnevognskurven ud for aksen der vippes henover. Nedenfor kan ses et billede af implementeringen. 
\figur{0.5}{vuggesystem/impl/Vuggeudsving_sensor.pdf}{Monteret Vuggeudsving sensor}{VS_Im_Vuggeudsving_Sensor}
Chippen er delvist skjult bag en beskyttelse. Den gule streg på billedet markerer aksen barnevognskurven og derved chippen vipper henover. 
De parsnoede ledning er for at beskytte I2C kommunikationen mod støj.


\subsubsection{Motor positionssensor}
Motor positionssensoren bliver ikke implementeret i denne iteration af projektet.

\newpage
\subsubsection{Mekanisk vuggesystem}
\label{Vuggesystem: Implementering_MV} 
Det mekaniske vuggesystem er implementeret ud fra skitsen i Vuggesystem Design Mekanisk Vuggesystem afsnit \vref{Vuggesystem: Design_MekVug}. \\
\textit{Motor:}\\
Motoren er placeret under barnevognskurvens tyngde center med en påsat gearing på 1:16 samt en kæde der giver en yderligere gearing på 1:8. Dette betyder at ved en hel vugning af barnevognskurven (fra yder position til yder position) roterer motoren 8 gange.
\figur{0.5}{vuggesystem/impl/Mekanisk_Vuggesystem_Motor.pdf}{Motor til det mekaniske vuggesystem med vist gearing}{VS_Im_Gear}
\figur{0.5}{vuggesystem/impl/Mekanisk_Vuggesystem_Akse.pdf}{Tandhjul påsat motoren til det mekaniske vuggesystem}{VS_Im_Akse}

\textit{Vuggeudsving:}
Som det ses på de tre nedenstående figurer så opfylder vuggesystemet kravspecifikationens ikke-funktionelle krav afsnit \ref{kravspec:ikke_funk_nivellering} om at barnevognen skal kunne vugge med mindst +/- 10 grader. Det implementerede vuggesystem  kan ideelt vippe ud til +/- 24,5 grader. Dette gør at Baby Watch systemet vil være i stand til at stå på en skrånende flade på op til 14,5 grader. Dette bliver ikke afprøvet og tested i denne iteration af projektet. 
\figur{0.35}{vuggesystem/impl/Mekanisk_Vuggesystem_Vandret.pdf}{Baby Watch barnevogn i vandret position}{VS_MV_Vandret}
\figur{0.35}{vuggesystem/impl/Mekanisk_Vuggesystem_Hojre.pdf}{Baby Watch barnevogn i højre yderposition}{VS_MV_Hojre}
\figur{0.35}{vuggesystem/impl/Mekanisk_Vuggesystem_Venstre.pdf}{Baby Watch barnevogn i venstre yderposition}{VS_MV_Venstre}
\textit{Stabilisering af barnevogn}:
Barnevogne har som standard fjedrende led. Disse led er blevet stabiliseret med spændebånd for at gøre barnevognens overføringsfunktion mere lineær. 
\figur{0.35}{vuggesystem/impl/Mekanisk_Vuggesystem_Opspaend.pdf}{Billede af stabiliseret barnevognsled}{VS_MV_Led}

\newpage
\subsection{Software implementering}
\subsubsection{Regulerings MCU}
Regulerings MCU'en er implementeret på et Cypress CY8CKIT-042 PSoC4 Pioneer Kit(REFERNCE). Denne platform består af en ARM Cortex-M0 CPU forbundet med en simpel FPGA der alt sammen kan programmes og styres med Cypress' egen udviklings suite, PSoC Creator 3(REFERENCE). Dette giver en fleksibel micro controller platform med mulighed for at bruge flere specialiseret embedded hardware FPGA blokke der kan styrer diverse interfaces, GPIO'er, Timer, interrupts mm. \\
På nedenstående Top Design for fra PSoC Creator kan hardware setup'et for Regulerings MCU'en ses. Hver firkant markerer en specialiseret funktionalitet håndteret af en eller flere hardware blokke.
\figur{1}{vuggesystem/impl/SW_ReguleringsMCU_Top_Design.JPG}{Top Design for Vuggesystems Regulerings MCU}{VS_impl_Reg_MCU}
Følgende vil gennemgå hver hver funktionalitet: \\
\textit{Sensor input:} \\ Denne boks består af en I2C master blok der sørger for et I2C-interface mellem Regulerings MCU'en og Vuggeudsving sensoren. Dette bruges i aflæsningen af sensoren. I dette setup er overføringshastigheden sat til Normal-Mode dvs. med en bitrate på 100 kHz. \\
\textit{Debug:} \\ Debug boksen sørger for et UART interface mellem PSoC4 micro controlleren og en computerterminal samt at sætte en GPIO-pin høj. Begge dele er til debugging af Regulerings MCU'en. \\
\textit{Motor styring:} \\ Motor styring består af en PWM blok med to PWM outputs der går til henholdvis Mos driver A og Mos driver B i motorstyringskredsen, se Vuggesystem Design Mosfet driver afsnit \vref{Vuggesytem:HW_DESIGN_MOSDRIVER}. Outputtene er inverterede i forhold til hinanden og via PWMblokken er der lavet et deadband mellem de to PWMsignaler. For yderligere beskrivelse af PWM-styresignalet kan afsnit \vref{Vuggesystem:Styresignal} i Vuggesystem Design Styresignal ses. \\
\textit{Loop timing:} \\ Denne funktionalitet bruges til at styre loop timingen for main funktionen i Regulerings MCU'en, også kaldet \verb+vuggeControl+. Firkanten indeholder tre hardware blokke, en Clock, en Timer og et Interrupt. Disse sørger tilsammen for at loop timingen for \verb+vuggeControl+ bliver 200 gange i sekundet. \\  
\textit{Shutdown switch:} \\ Denne GPIO-pin sættes høj (3.3V) hvis forbindelsen til motoren skal lukkes. Dette er ikke implementeret i denne iteration af projektet. \\
\textit{Controller I2C:} \\ Denne boks består af et I2C-Slave interface der sørger for komminkationen mellem Regulerings MCU'en og Baby Watch Controller. Denne I2C bus forbindelse kører ligeledes med Normal-Mode. \\ 
\textit{Endstop switch:} \\ Endstop switch boksen består af en pulled-up GPIO-pin forbundet med et Interrupt. Denne funktionalitet bruges til Endstopsensorne, afsnit \vref{EndstopS_IBD} i Vuggesystem Systemarkitektur Hardware arkitektur. Ved aktivering af en Endstop sensor trækkes signalet lav og interruptet aktives \\ 

\textbf{Beskrivelse af fysiske output fra PSoC4 Pioneer Kittet:} \\

\textbf{Beskrivelse af C kode filerne i Regulerings MCU:} \\
Koden er implementeret som beskrevet i applikations modellen fra Vuggesystem Systemarkitektur afsnit \vref{Vuggesystem:SD} og klassediagrammet fra Vuggesystem Design Software design \vref{VuggeSystem_Klassediagram}. \\
\textbf{vuggeControl (main):} \\
Tanken bag vuggesystemets main-funktion \verb+VuggeControl+, er at den under opstart skal initier alle hardware blokkene og deres funktionaliteter igennem initierings kald til de andre  filer i Regulerings MCU. Derefter skal den kører i loop med en frekvens på 200Hz. Hvilket er beskrevet i sekvensdiagrammet for Regulerings MCU'en. \\ \verb+VuggeControl+filen indeholder få hjælpefunktioner som hver især sørger for tjekke system kritiske informationer, debugging eller nødstop af motoren(Hvilket ikke er fuldt implementeret i denne iteration af projektet). \\Af systemkritiske informationer kan nævnes; et eksternt interrupt om at en Endstop Sensor er aktiveret og at systemet derfor skal gå i nødstop, at Baby Watch Controller vil slukke vuggesystemet og at regulerings status skal tjekkes for fejl i reguleringen.\\ Nødstop-funktionen LukSystem() er egentligt tiltænkt at skulle slukke et relæ der styrer strømtilførelsen til motoren men som nævnt tidligere er denne funktionalitet ikke implementeret i denne udgave af projektet. Funktionen sørger istedet for at neutraliserer PWM-signalet der styrer motoren så motoren derigennem ikke får strøm. \\ Til at styrer main-loopets 200Hz hastighed bruges et timer-interrupt der sætter et flag højt hver gang et nyt gennemløb af loopet skal køres. I main-loopet kaldes der først førnævnte system kritiske tjek efterfulgt af en opdatering af de nyeste vuggeudsving- og vuggefrekvensværdier fra Baby Watch Controller, herefter hentes og beregnes barnevognskurvens vinkel. Denne vinkel videresendes til reguleringen som beregner et output som lægges ind til motorstyringens PWM blok. Loopet slutter med at resette flaget så det er klart til et nyt gennemløb. \\
\textbf{i2cKommunikation} \\ 
\verb+i2cKommunikation+ filen sørger for initierer den førnævnte Controller I2C hardware der indeholdte et I2C Slave interface og derefter bruge denne til at opdaterer et I2C register med informationer som skal kommunikeres mellem de to moduler jf. Grænseflade mellem Vuggesystem og Controller i den overordnede Baby Watch Systemarkitektur afsnit \vref{overordnet:i2c_tabel}. Som sikkerhed i kommunikationen er der sat begrænsning på at register 0x04 der indeholder vuggesystemet status ikke kan ændres udfra dvs. fra Baby Watch Controller.
\label{vugsys:impl, sensFortolk} (\ref{vugsys:impl, sensFortolk}) \textbf{sensorFortolker}  \\
\verb+sensorFortolker+ står for alt kommunikation mellem sensorer (Endstop Sensor og Vuggeudsving sensor) og Regulerings MCU samt beregninger af data fra disse der giver barnevognskurvens nuværende vinkel. Dette gøres, som nævnt under Regulerings MCUs hardware moduler, vha. hjælp af et I2C Master interface og et GPIO styret interrupt. 
\textbf{Sensor konfiguration:} \\
Da den valgte sensorkreds (MPU6050) er i stand til at køre på mange forskellige måder kræves der en indledende opsætning af sensoren før den kan benyttes. Dette gøres ved at skrive til en række registre på enheden gennem I2C bussen (REF I2C protokol). Der skrives til følgende registre:
\begin{center}
    \begin{tabular}{| c | c | p{8cm} |}
    \hline
    \textbf{Register}	& \textbf{værdi} & \textbf{kommentar} \\ \hline
    0x19 & 0b00000100 & sætter dataraten til 200Hz \\
    0x1A & 0b00000101 & sætter knækfrekvensen for sensorens digitale lavpasfilter til 10 Hz \\
    0x1A & 0b00000101 & sætter knækfrekvensen for sensorens digitale lavpasfilter til 10 Hz \\
    0x1B & 0b00011000 & gyropskopet indstilles til +/- 2000 grader i sekundet  \\
    0x1C & 0b00001000 & accelerometeret indstilles til +/- 4g \\
    0x1B & 0b00011000 & gyropskopet indstilles til +/- 2000 grader i sekundet  \\
    0x1C & 0b00001000 & accelerometeret indstilles til +/- 4g \\
    0x6B & 0b00000001 & chippens clk sættes til at være x gyroskopets oscilator, da denne er mere præcis \\ \hline
    \end{tabular}
\end{center}
\textbf{Dataindsamling:} \\
MPU6050 chippen genererer en puls på dataInt benet, hvorefter der læses fra følgende I2C registre:
\figur{0.75}{vuggesystem/impl/i2cDataReg.pdf}{udsnit af i2c register oversigt fra datablad}{vugsys:dataReg}
Herefter bitshiftes de høje databytes (\_H) 8 bits til vænstre og adderes med de tilhørende lave databytes.\\
textbf{Databehandling:} \\
Før de indsamlede data fra de to sensorer kan samles udregnes først den estimerede vinkel for hver af de to sensorer hver for sig. For accelerometeret gøres dette ved at tage arcus tangens for Y- og Z-aksen\\
MERE

\textbf{regulering} \\
Denne fil sørger for at beregne regulerings outputtet, initierer PWM blokken og styrer denne PWM blok. Reguleringen sørger også for at lave fejltjek på på de vuggeudsvings- og vuggefrekvensværdier fra Baby Watch Controller før de bruges. Dette gøres for at øge datasikkerheden. Reguleringen bruger disse værdier sammen med den nuværende vinkel angivet i et fixed16.16 dataformat til at beregne et output til motorstyringens PWM. 
\\ MERE \\
