\section{Systemarkitektur}

I dette afsnit beskrives systemarkitekturen for vuggesystemet.

\subsection*{Overordnet virkemåde}
Vuggesystemet fungerer overordnet som følger:
\begin{itemize}
	\item Vuggesystemets Regulerings MCU står for at vugge barnevognens kurv med en bestemt vuggefrekvens og et bestemt vinkeludsving. Dette sker på baggrund af værdier for disse modtaget fra Controller
	\item Regulerings MCU'en regulerer vuggesystemet således at vugningen altid foregår ud fra en vandret akse samt at de modtagne værdier for vuggefrekvensen og vinkeludsvinget overholdes  
	\item Kommunikation mellem Regulerings MCU og Controlleren foregår via I2C protokollen
\end{itemize}

\subsection{Hardware arkitektur}

\figur{1}{vuggesystem/sysark/Vuggesystem_BDD.pdf}{BDD for Vuggesystem}{Vug_BDD}

Vuggesystemet består af tre dele
\begin{description}
\item[Motorsystem block:] Består af en motor til at drive vuggebevægelsen samt en motorkreds til strømstyringen af motoren. Motorkredsen sørger for at motorens ankerspænding styres vha dutycycle på et PWM-signal og retningen på motoren styres af et logisk signal.
\item[Regulerings MCU block:] Styringsenheden for vuggesystemet. Denne sørger for reguleringen af vuggesystemet samt kommunikationen til og fra controlleren.
\item[Sensor block:] Består af fire sensorer; to Endstop sensorer som måler om barnevognens kurv har nået den mekaniske vuggegrænse, Vuggevinkel sensor måler kurvens absolutte vinkel i forhold til tyngdefelt og Motor positionssensoren måler motorens position.
\end{description}

Følgende beskriver vuggesystemets kobling og grænseflade.

\figur{1}{vuggesystem/sysark/Vuggesystem_IBD.pdf}{IBD for Vuggesystem}{Vug_IBD}

\vspace{5mm} 

\figur{0.5}{vuggesystem/sysark/Endstop_sensor_IBD.pdf}{IBD for Endstop sensorer}{EndstopS_IBD}
\textbf{Endstop sensorer} består af to ens sensorer, hhv. \textbf{Endstop sensor front}, placeret til at detekterer hvis barnevognskurven når den mekaniske vuggegrænse ved fremad vuggeretning, og \textbf{Endstop sensor rear}, placeret til at detekterer hvis barnevognskurven når den mekaniske vuggegrænse ved bagud vuggeretning. Sensorerne giver det samme signal uanset om detekteringen sker i front eller bag.

\vspace{5mm}

\figur{0.5}{vuggesystem/sysark/Vuggevinkel_sensor_IBD.pdf}{IBD for Vuggevinkel sensor}{VugVinkS_IBD}
\textbf{Vuggevinkel sensor} er placeret så den måler barnevognskurvens plan i forhold til jordens tyngdefelt. 

\vspace{5mm}

\figur{0.5}{vuggesystem/sysark/motor_positions_sensor_IBD.pdf}{IBD for Motor positionssensor}{MotoPosS_IBD}
\textbf{Motor positionssensor} giver et frekvenssignal relativ til motorens nuværende hastighed. 

\subsection{Grænsefladebeskrivelse}
Herunder findes en beskrivelse af grænsefladen både til denne del af systemet, samt de interne forbindelser. 

\subsection*{I2C beskrivelse}
Forbindelserne ud og ind af dette delsystem er samlet i en I2C bus, som er beskrevet her:

\begin{center}
\begin{longtable}{|p{1cm}|p{2cm}|p{1cm}|p{5.5cm}|p{2.5cm}|}
\caption[i2cBeskrivelse]{Specifikation af I2C grænseflade} 

\label{i2c_tabel} \\

\hline 

\multicolumn{5}{|l|}{\textbf{I2C Adresse:} 0b1111000X  (Write: 0xF0, Read: 0xF1)} \\ \hline
\multicolumn{5}{|l|}{\textbf{I2C Frekvens:} 100kHz} \\ \hline

\textbf{Reg\#} & \textbf{Navn} & \textbf{Type} & \textbf{Beskrivelse} & \textbf{Startværdi} \\
\hline 
\endfirsthead


\multicolumn{5}{c}{{\bfseries \tablename\ \thetable{} --> fortsat fra forrige side}} \\
\multicolumn{5}{c}{} \\

\hline
\textbf{Reg\#} & \textbf{Navn} & \textbf{Type} & \textbf{Beskrivelse} & \textbf{Startværdi} \\
\hline 
\endhead


\multicolumn{5}{r}{{fortsættes på næste side -->}} \\ 
 
\endfoot

0x00 & ID & \textbf{R} & Indeholder et id som kan benyttes til at identificere denne enhed, eller til at teste forbindelsen til denne. & 0xFB \\ \hline

0x01 & Status & \textbf{R} & Indeholder en bitsekvens som indikerer systemets status. Registeret indeholder følgende: [ERR STALL END\_STP SD\_RDY X X X X] & 0b0000XXXX \\ \hline

\multicolumn{2}{|r|}{\textbf{ERR}} & \multicolumn {3}{p{8cm} |} {Indikerer at der er opstået en fejl i systemet. Kendes årsagen til fejlen indikeres denne i STALL og END\_STP} \\ \hline

\multicolumn{2}{|r|}{\textbf{STALL}} & \multicolumn {3}{p{8cm} |} {Indikerer at systemet har været ude af stand til at drive motoren, formegentlig pga for stor belastning} \\ \hline

\multicolumn{2}{|r|}{\textbf{END\_STP}} & \multicolumn {3}{p{8cm} |} {Indikerer at vuggen har ramt en af sine mekaniske yderpositioner, og vuggesystemet er deaktiveret indtil der er blevet genstartet.} \\ \hline

\multicolumn{2}{|r|}{\textbf{SD\_RDY}} & \multicolumn {3}{p{8cm} |} {Indikerer at systemet er klar til at få afbrudt strømmen} \\ \hline

0x02 & ON\_OFF & \textbf(R/W) & Dette register benyttes til at tænde og slukke for systemet. Skrives et nul til dette register begynder systemet at lukke ned. Strømmen til systemet bør ikke afbrydes før SD\_RDY i status registeret er skiftet til et. Hvis systemet er tændt indeholder registeret en værdi forskellig fra 0. & 0xFF \\ \hline

0x03 & Frekvens & \textbf{R/W} & Værdien i dette register styrer frekvensen hvormed der vugges. Område: \SI{0}{\hertz} = \SI{2.550}{\hertz},  1 LSB = \SI{10}{\milli\hertz}. & 0x00 \\ \hline

0x04 & Vinkeludsving & \textbf{R/W} & Værdien i dette register kontrollerer størrelsen af vuggens udsving i grader. Område: +/- \SI{12.75}{\degree}, 1 LSB = \SI{0.05}{\degree}. & 0x00 \\ \hline

\hline \hline
\endlastfoot

\end{longtable}
\end{center}

\subsection*{Signalbeskrivelse}
\begin{center}
\begin{longtable}{|p{3cm}|p{2cm}|p{6cm}|}
\caption[Signalbeskrivelse for vuggesystem]{Signalbeskrivelse} 

\label{signalbeskr_vugge_tabel} \\

\hline 

\multicolumn{1}{|p{3cm}|}{\textbf{Signal}} & 
\multicolumn{1}{p{2cm}|}{\textbf{Type}} & 
\multicolumn{1}{p{6cm}|}{\textbf{Kommentar}} \\
\hline 
\endfirsthead


\multicolumn{3}{c}%
{{\bfseries \tablename\ \thetable{} --> fortsat fra forrige side}} \\

\multicolumn{1}{|p{3cm}|}{\textbf{Signal}} & 
\multicolumn{1}{p{2cm}|}{\textbf{Type}} & 
\multicolumn{1}{p{6cm}|}{\textbf{Kommentar}} \\
\hline
\endhead


\hline \multicolumn{3}{|r|}{{fortsættes på næste side -->}} \\ \hline
\endfoot

\hline \hline
\endlastfoot

VB & 12V DC & Dette signal kommer direkte fra systemets batteri.\\
\hline
VS & 0V DC & Dette er batteriforsyningens retur\\
\hline
VCC & 3.3V DC & Dette er forsyningen til PSoC og andet logik.\\
\hline
GND & 0V stel & Stelforbindelse til PSoC og andet logik\\
\hline
MotRetning & Digital & HIGH = CW, LOW = CCW\\
\hline
MotSpænding & PWM & PWM som styrer motor spændingen ved VB * \%dc. PWM signalet 0-3.3V CMOS med f = [???]\\
\hline
VuggeV & I2C & Angiver vinklen af vuggen relativt til tyngdefeltet.\\
\hline
MotHast & ?? & Angiver hastigheden af motoren\\
\hline
ESSwitch & Digital & Endstop status, ES-for OR ES-bag, HIGH = ikke ramt LOW = ramt.\\
\hline
I2CVuggesystem & I2C & Styresignal til vuggesystemet\\
\hline
MotForbind & DCMotorSig & Motor tilkobling\\
\hline

\end{longtable}
\end{center}



\newpage
\subsection{Software arkitektur}